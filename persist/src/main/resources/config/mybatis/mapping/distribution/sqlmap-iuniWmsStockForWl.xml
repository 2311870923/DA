<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="wmsStockForWl">

    <!-- 仓库出入库数量汇总报表 明细 -->
    <sql id="selectWmsStockForWlDetail">
        SELECT DATETIME,
        WAREHOUSECODE,
        WAREHOUSE,
        SKUCODE,
        GOODSNAME,
        SKUNAME,
        MATERIALCODE,
        MEASUREUNIT,
        SUM(INSTOCKQTY) "INSTOCKQTY",
        SUM(INDEFEQTY) "INDEFEQTY",
        SUM(INNONDEFEQTY) "INNONDEFEQTY",
        SUM(CGRK) "CGRK",
        SUM(OUTSTOCKQTY) "OUTSTOCKQTY",
        SUM(OUTDEFEQTY) "OUTDEFEQTY",
        SUM(OUTNONDEFEQTY) "OUTNONDEFEQTY",
        SUM(ENDSTOCKQTY) "ENDSTOCKQTY",
        SUM(ENDNONDEFEQTY) "ENDNONDEFEQTY",
        SUM(ENDDEFEQTY) "ENDDEFEQTY",
        SUM(OCCUPYSTOCKQTY) "OCCUPYSTOCKQTY"
        FROM (
        SELECT IWSD.DATETIME "DATETIME",
        IWWH.WAREHOUSE_CODE "WAREHOUSECODE",
        IWWH.WAREHOUSE_NAME "WAREHOUSE",
        IWSD.SKU_CODE "SKUCODE",
        IWW.WARES_NAME "GOODSNAME",
        IWS.SKU_NAME "SKUNAME",
        IWS.MATERIAL_CODE "MATERIALCODE",
        IWW.MEASURE_UNIT "MEASUREUNIT",
        SUM(IWSD.INSTOCKQTY) "INSTOCKQTY",
        SUM(IWSD.INDEFEQTY) "INDEFEQTY",
        SUM(IWSD.INNONDEFEQTY) "INNONDEFEQTY",
        0 "CGRK",
        SUM(IWSD.OUTSTOCKQTY) "OUTSTOCKQTY",
        SUM(IWSD.OUTDEFEQTY) "OUTDEFEQTY",
        SUM(IWSD.OUTNONDEFEQTY) "OUTNONDEFEQTY",
        0 "ENDSTOCKQTY",
        0 "ENDNONDEFEQTY",
        0 "ENDDEFEQTY",
        0 "OCCUPYSTOCKQTY"
        FROM (SELECT TO_CHAR(REPORT_DATE, #dateStyle#) "DATETIME", X.*
        FROM SYN_WMS_STOCK_DAILYSTOCK X) IWSD
        LEFT JOIN SYN_WMS_SKU IWS
        ON IWSD.SKU_CODE = IWS.SKU_CODE
        LEFT JOIN SYN_WMS_WARES IWW
        ON IWW.ID = IWS.WARES_ID
        LEFT JOIN SYN_WMS_WAREHOUSE IWWH
        ON IWWH.WAREHOUSE_CODE = (CASE
        WHEN IWSD.STOCK_ID IS NULL THEN
        '0769'
        ELSE
        IWSD.STOCK_ID
        END)
        <where>
            <if test="beginDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        GROUP BY IWSD.DATETIME,
        IWWH.WAREHOUSE_CODE,
        IWWH.WAREHOUSE_NAME,
        IWSD.SKU_CODE,
        IWW.WARES_NAME,
        IWS.SKU_NAME,
        IWS.MATERIAL_CODE,
        IWW.MEASURE_UNIT
        UNION ALL
        SELECT IWSD.DATETIME "DATETIME",
        IWWH.WAREHOUSE_CODE "WAREHOUSECODE",
        IWWH.WAREHOUSE_NAME "WAREHOUSE",
        IWSD.SKU_CODE "SKUCODE",
        IWW.WARES_NAME "GOODSNAME",
        IWS.SKU_NAME "SKUNAME",
        IWS.MATERIAL_CODE "MATERIALCODE",
        IWW.MEASURE_UNIT "MEASUREUNIT",
        0 "INSTOCKQTY",
        0 "INDEFEQTY",
        0 "INNONDEFEQTY",
        0 "CGRK",
        0 "OUTSTOCKQTY",
        0 "OUTDEFEQTY",
        0 "OUTNONDEFEQTY",
        IWSD.ENDSTOCKQTY "ENDSTOCKQTY",
        IWSD.ENDNONDEFEQTY "ENDNONDEFEQTY",
        IWSD.ENDDEFEQTY "ENDDEFEQTY",
        IWSD.OCCUPYSTOCKQTY "OCCUPYSTOCKQTY"
        FROM (SELECT SKU_CODE,
        CASE
        WHEN MAX(REPORT_DATE) >= TO_DATE(#endDate#, 'YYYY-MM-DD') THEN TO_DATE(#endDate#, 'YYYY-MM-DD')
        ELSE
        MAX(REPORT_DATE)
        END LAST_REPORT_DATE
        FROM SYN_WMS_STOCK_DAILYSTOCK
        <where>
            <if test="beginDate != null">
                AND REPORT_DATE <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND REPORT_DATE <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        GROUP BY TO_CHAR(REPORT_DATE, #dateStyle#), SKU_CODE) LD
        LEFT JOIN (SELECT TO_CHAR(REPORT_DATE, #dateStyle#) "DATETIME",
        X.*
        FROM SYN_WMS_STOCK_DAILYSTOCK X) IWSD
        ON LD.SKU_CODE = IWSD.SKU_CODE
        AND LD.LAST_REPORT_DATE = IWSD.REPORT_DATE
        LEFT JOIN SYN_WMS_SKU IWS
        ON IWSD.SKU_CODE = IWS.SKU_CODE
        LEFT JOIN SYN_WMS_WARES IWW
        ON IWW.ID = IWS.WARES_ID
        LEFT JOIN SYN_WMS_WAREHOUSE IWWH
        ON IWWH.WAREHOUSE_CODE = (CASE
        WHEN IWSD.STOCK_ID IS NULL THEN
        '0769'
        ELSE
        IWSD.STOCK_ID
        END)
        <where>
            <if test="beginDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        UNION ALL
        SELECT SWSC.DATETIME "DATETIME",
        SWW.WAREHOUSE_CODE "WAREHOUSECODE",
        SWW.WAREHOUSE_NAME "WAREHOUSE",
        SWSS.SKU_CODE "SKUCODE",
        SWWW.WARES_NAME "GOODSNAME",
        SWSS.SKU_NAME "SKUNAME",
        SWSS.MATERIAL_CODE "MATERIALCODE",
        SWWW.MEASURE_UNIT "MEASUREUNIT",
        0 "INSTOCKQTY",
        0 "INDEFEQTY",
        0 "INNONDEFEQTY",
        SUM(SWSC.QUANTITY) "CGRK",
        0 "OUTSTOCKQTY",
        0 "OUTDEFEQTY",
        0 "OUTNONDEFEQTY",
        0 "ENDSTOCKQTY",
        0 "ENDNONDEFEQTY",
        0 "ENDDEFEQTY",
        0 "OCCUPYSTOCKQTY"
        FROM (SELECT TO_CHAR(CREATE_TIME, #dateStyle#) "DATETIME", X.*
        FROM SYN_WMS_STOCK_CHANGE X) SWSC
        LEFT JOIN SYN_WMS_STOCK SWS
        ON SWSC.STOCK_ID = SWS.ID
        LEFT JOIN SYN_WMS_WAREHOUSE SWW
        ON SWS.WAREHOUSE_ID = SWW.ID
        LEFT JOIN SYN_WMS_SKU SWSS
        ON SWS.SKU_ID = SWSS.ID
        LEFT JOIN SYN_WMS_WARES SWWW
        ON SWSS.WARES_ID = SWWW.ID
        <where>
            SWSC.STOCK_TYPE = '4'
            AND BIZ_TYPE = '101'
            <if test="beginDate != null">
                AND SWSC.CREATE_TIME <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND SWSC.CREATE_TIME <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        GROUP BY SWSC.DATETIME,
        SWW.WAREHOUSE_CODE,
        SWW.WAREHOUSE_NAME,
        SWSS.SKU_CODE,
        SWSS.SKU_NAME,
        SWWW.WARES_NAME,
        SWSS.MATERIAL_CODE,
        SWWW.MEASURE_UNIT
        )
        <where>
            <if test="endDate != null">
                AND SKUCODE IN
                <foreach collection="skuCodes" item="item" index="index" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="warehouseCode != null">
                WAREHOUSECODE = #warehouseCode#
            </if>
        </where>
        GROUP BY DATETIME,
        WAREHOUSECODE,
        WAREHOUSE,
        SKUCODE,
        GOODSNAME,
        SKUNAME,
        MATERIALCODE,
        MEASUREUNIT
        ORDER BY DATETIME, WAREHOUSECODE, SKUCODE
    </sql>

    <!-- 仓库出入库数量汇总报表 汇总 -->
    <sql id="iuniWmsStockForWl_query_sum">
        SELECT DATETIME,
        WAREHOUSECODE,
        WAREHOUSE,
        SKUCODE,
        GOODSNAME,
        SKUNAME,
        MATERIALCODE,
        MEASUREUNIT,
        SUM(INSTOCKQTY) "INSTOCKQTY",
        SUM(INDEFEQTY) "INDEFEQTY",
        SUM(INNONDEFEQTY) "INNONDEFEQTY",
        SUM(CGRK) "CGRK",
        SUM(OUTSTOCKQTY) "OUTSTOCKQTY",
        SUM(OUTDEFEQTY) "OUTDEFEQTY",
        SUM(OUTNONDEFEQTY) "OUTNONDEFEQTY",
        SUM(ENDSTOCKQTY) "ENDSTOCKQTY",
        SUM(ENDNONDEFEQTY) "ENDNONDEFEQTY",
        SUM(ENDDEFEQTY) "ENDDEFEQTY",
        SUM(OCCUPYSTOCKQTY) "OCCUPYSTOCKQTY"
        FROM (
        SELECT #beginDate# || '~' || #endDate# "DATETIME",
        IWWH.WAREHOUSE_CODE "WAREHOUSECODE",
        IWWH.WAREHOUSE_NAME "WAREHOUSE",
        IWSD.SKU_CODE "SKUCODE",
        IWW.WARES_NAME "GOODSNAME",
        IWS.SKU_NAME "SKUNAME",
        IWS.MATERIAL_CODE "MATERIALCODE",
        IWW.MEASURE_UNIT "MEASUREUNIT",
        SUM(IWSD.INSTOCKQTY) "INSTOCKQTY",
        SUM(IWSD.INDEFEQTY) "INDEFEQTY",
        SUM(IWSD.INNONDEFEQTY) "INNONDEFEQTY",
        0 "CGRK",
        SUM(IWSD.OUTSTOCKQTY) "OUTSTOCKQTY",
        SUM(IWSD.OUTDEFEQTY) "OUTDEFEQTY",
        SUM(IWSD.OUTNONDEFEQTY) "OUTNONDEFEQTY",
        0 "ENDSTOCKQTY",
        0 "ENDNONDEFEQTY",
        0 "ENDDEFEQTY",
        0 "OCCUPYSTOCKQTY"
        FROM SYN_WMS_STOCK_DAILYSTOCK IWSD
        LEFT JOIN SYN_WMS_SKU IWS
        ON IWSD.SKU_CODE = IWS.SKU_CODE
        LEFT JOIN SYN_WMS_WARES IWW
        ON IWW.ID = IWS.WARES_ID
        LEFT JOIN SYN_WMS_WAREHOUSE IWWH
        ON IWWH.WAREHOUSE_CODE = (CASE
        WHEN IWSD.STOCK_ID IS NULL THEN
        '0769'
        ELSE
        IWSD.STOCK_ID
        END)
        <where>
            <if test="beginDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ < ]]>  TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        GROUP BY IWWH.WAREHOUSE_CODE,
        IWWH.WAREHOUSE_NAME,
        IWSD.SKU_CODE,
        IWW.WARES_NAME,
        IWS.SKU_NAME,
        IWS.MATERIAL_CODE,
        IWW.MEASURE_UNIT
        UNION ALL
        SELECT #beginDate# || '~' || #endDate# "DATETIME",
        IWWH.WAREHOUSE_CODE "WAREHOUSECODE",
        IWWH.WAREHOUSE_NAME "WAREHOUSE",
        IWSD.SKU_CODE "SKUCODE",
        IWW.WARES_NAME "GOODSNAME",
        IWS.SKU_NAME "SKUNAME",
        IWS.MATERIAL_CODE "MATERIALCODE",
        IWW.MEASURE_UNIT "MEASUREUNIT",
        0 "INSTOCKQTY",
        0 "INDEFEQTY",
        0 "INNONDEFEQTY",
        0 "CGRK",
        0 "OUTSTOCKQTY",
        0 "OUTDEFEQTY",
        0 "OUTNONDEFEQTY",
        IWSD.ENDSTOCKQTY "ENDSTOCKQTY",
        IWSD.ENDNONDEFEQTY "ENDNONDEFEQTY",
        IWSD.ENDDEFEQTY "ENDDEFEQTY",
        IWSD.OCCUPYSTOCKQTY "OCCUPYSTOCKQTY"
        FROM (SELECT SKU_CODE,
        CASE
        WHEN MAX(REPORT_DATE) <![CDATA[ >= ]]>
        TO_DATE(#endDate#, 'YYYY-MM-DD') THEN
        TO_DATE(#endDate#, 'YYYY-MM-DD')
        ELSE
        MAX(REPORT_DATE)
        END LAST_REPORT_DATE
        FROM SYN_WMS_STOCK_DAILYSTOCK
        <where>
            <if test="beginDate != null">
                REPORT_DATE <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND REPORT_DATE <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        GROUP BY SKU_CODE) LD
        LEFT JOIN SYN_WMS_STOCK_DAILYSTOCK IWSD
        ON LD.SKU_CODE = IWSD.SKU_CODE
        AND LD.LAST_REPORT_DATE = IWSD.REPORT_DATE
        LEFT JOIN SYN_WMS_SKU IWS
        ON IWSD.SKU_CODE = IWS.SKU_CODE
        LEFT JOIN SYN_WMS_WARES IWW
        ON IWW.ID = IWS.WARES_ID
        LEFT JOIN SYN_WMS_WAREHOUSE IWWH
        ON IWWH.WAREHOUSE_CODE = (CASE
        WHEN IWSD.STOCK_ID IS NULL THEN
        '0769'
        ELSE
        IWSD.STOCK_ID
        END)
        <where>
            <if test="beginDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        UNION ALL
        SELECT #beginDate# || '~' || #endDate# "DATETIME",
        SWW.WAREHOUSE_CODE "WAREHOUSECODE",
        SWW.WAREHOUSE_NAME "WAREHOUSE",
        SWSS.SKU_CODE "SKUCODE",
        SWWW.WARES_NAME "GOODSNAME",
        SWSS.SKU_NAME "SKUNAME",
        SWSS.MATERIAL_CODE "MATERIALCODE",
        SWWW.MEASURE_UNIT "MEASUREUNIT",
        0 "INSTOCKQTY",
        0 "INDEFEQTY",
        0 "INNONDEFEQTY",
        SUM(SWSC.QUANTITY) "CGRK",
        0 "OUTSTOCKQTY",
        0 "OUTDEFEQTY",
        0 "OUTNONDEFEQTY",
        0 "ENDSTOCKQTY",
        0 "ENDNONDEFEQTY",
        0 "ENDDEFEQTY",
        0 "OCCUPYSTOCKQTY"
        FROM SYN_WMS_STOCK_CHANGE SWSC
        LEFT JOIN SYN_WMS_STOCK SWS
        ON SWSC.STOCK_ID = SWS.ID
        LEFT JOIN SYN_WMS_WAREHOUSE SWW
        ON SWS.WAREHOUSE_ID = SWW.ID
        LEFT JOIN SYN_WMS_SKU SWSS
        ON SWS.SKU_ID = SWSS.ID
        LEFT JOIN SYN_WMS_WARES SWWW
        ON SWSS.WARES_ID = SWWW.ID
        <where>
            SWSC.STOCK_TYPE = '4'
            AND BIZ_TYPE = '101'
            <if test="beginDate != null">
                AND SWSC.CREATE_TIME <![CDATA[ >= ]]> TO_DATE(#beginDate#, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null">
                AND SWSC.CREATE_TIME <![CDATA[ < ]]> TO_DATE(#endDate#, 'YYYY-MM-DD') + 1
            </if>
        </where>
        GROUP BY
        SWW.WAREHOUSE_CODE,
        SWW.WAREHOUSE_NAME,
        SWSS.SKU_CODE,
        SWSS.SKU_NAME,
        SWWW.WARES_NAME,
        SWSS.MATERIAL_CODE,
        SWWW.MEASURE_UNIT
        )
        <where>
            <if test="skuCodes != null">
                AND SKUCODE IN
                <foreach collection="skuCodes" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="warehouseCode != null">
                WAREHOUSECODE = #warehouseCode#
            </if>
        </where>
        GROUP BY DATETIME,
        WAREHOUSECODE,
        WAREHOUSE,
        SKUCODE,
        GOODSNAME,
        SKUNAME,
        MATERIALCODE,
        MEASUREUNIT
        ORDER BY DATETIME, WAREHOUSECODE, SKUCODE
    </sql>

</mapper>
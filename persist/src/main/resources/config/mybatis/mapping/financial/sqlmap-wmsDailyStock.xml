<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="wmsDailyStock">

    <!-- 库存明细报表 -->
    <sql id="selectWmsStockDetails">
        select * from (
        select IWSD.REPORT_DATE "date",
        IWWH.WAREHOUSE_CODE "warehouseCode",
        IWWH.WAREHOUSE_NAME "wareHouse",
        IWSD.SKU_CODE "skuCode",
        IWS.Material_Code "materialCode",
        IWW.Wares_Name "goodsName",
        IWS.Sku_Name "skuName",
        IWW.MEASURE_UNIT "measureUnit",
        SUM(IWSD.ENDNONDEFEQTY) "acceptedGoods",
        SUM(IWSD.ENDDEFEQTY) "defectiveGoods",
        SUM(IWSD.ENDSTOCKQTY) "totalGoods"
        from SYN_WMS_STOCK_DAILYSTOCK IWSD
        LEFT JOIN SYN_WMS_SKU IWS
        ON IWSD.SKU_CODE = IWS.SKU_CODE
        LEFT JOIN SYN_WMS_WARES IWW
        ON IWW.Id = IWS.WARES_ID
        LEFT JOIN SYN_WMS_WAREHOUSE IWWH
        ON IWWH.ID = (CASE
        WHEN IWSD.STOCK_ID IS NULL THEN
        '1083672'
        ELSE
        IWSD.STOCK_ID
        END)
        <where>
            <if test="beginDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ >= ]]> to_date(#beginDate#,'yyyy-mm-dd')
            </if>
            <if test="endDate != null">
                AND IWSD.REPORT_DATE <![CDATA[ < ]]> to_date(#endDate#,'yyyy-mm-dd')+1
            </if>
        </where>
        GROUP BY IWSD.REPORT_DATE, IWWH.WAREHOUSE_CODE, IWWH.WAREHOUSE_NAME, IWSD.SKU_CODE, IWW.Wares_Name,
        IWS.Sku_Name, IWW.MEASURE_UNIT,
        IWS.Material_Code
        ) TMP
        <where>
            <if test="wareHouse != null">
                AND TMP."wareHouse" LIKE '%' || #wareHouse# || '%'
            </if>
            <if test="materialCode != null">
                AND TMP."materialCode" LIKE '%' || #materialCode# || '%'
            </if>
            <if test="warehouseCode != null">
                AND TMP."warehouseCode" = #warehouseCode#
            </if>
        </where>
        order by TMP."date", TMP."skuCode"
    </sql>

</mapper>